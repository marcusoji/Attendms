<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Attendance System</title>
     <link rel="stylesheet" href="css/style.css">
</head>
<body>

   <div class="container">
        <!-- PAGE 1: AUTHENTICATION -->
        <div id="authPage" class="page active">
            <h1>School Attendance System</h1>
            <canvas id="captureCanvas" class="hidden"></canvas>

            <div class="card">
                <div class="toggle-container">
                    <button id="authToggleLogin" class="toggle-btn active" onclick="switchAuthMode('login')">Login</button>
                    <button id="authToggleRegister" class="toggle-btn" onclick="switchAuthMode('register')">Register</button>
                </div>

                <!-- LOGIN FORM --> 
                <div id="loginForm">
                    <div class="tab-container">
                        <button class="tab-btn active" data-user-type="student" onclick="switchUserType(this)">Student</button>
                        <button class="tab-btn" data-user-type="lecturer" onclick="switchUserType(this)">Lecturer</button>
                        <button class="tab-btn" data-user-type="admin" onclick="switchUserType(this)">Admin</button>
                    </div>
                    <form id="login-form-element">
                        <!-- Student Login Fields -->
                        <div class="form-fields" data-for-type="student">
                            <input type="text" name="matNo" placeholder="Matriculation Number" required>
                            <div class="face-scan-section">
                                <h3>Face Scan Login</h3>
                                <video id="video-preview-login" autoplay playsinline></video>
                                <div id="loginScanStatus" class="success-msg"></div>
                                <button type="button" class="secondary-btn" onclick="startCamera('video-preview-login')">1. Start Camera</button>
                                <button type="button" class="secondary-btn" onclick="captureFace('video-preview-login', 'loginScanStatus')">2. Capture Face</button>
                            </div>
                        </div>
                        <!-- Lecturer/Admin Login Fields -->
                        <div class="form-fields hidden" data-for-type="lecturer admin">
                            <input type="email" name="email" placeholder="Email Address" required>
                            <input type="password" name="password" placeholder="Password" required>
                        </div>
                        <div id="loginError" class="error-msg"></div>
                        <button type="submit">Login</button>
                    </form>
                </div>

                <!-- REGISTER FORM -->
                <div id="registerForm" class="hidden">
                     <div class="tab-container">
                        <button class="tab-btn active" data-user-type="student" onclick="switchUserType(this)">Student</button>
                        <button class="tab-btn" data-user-type="lecturer" onclick="switchUserType(this)">Lecturer</button>
                    </div>
                    <form id="register-form-element">
                         <!-- Student Register Fields -->
                         <div class="form-fields" data-for-type="student">
                            <input type="text" name="name" placeholder="Full Name" required>
                            <input type="text" name="matNo" placeholder="Matriculation Number" required>
                            <input type="email" name="email" placeholder="Email Address" required>
                            <input type="tel" name="phone" placeholder="Phone Number" required>
                            <div class="face-scan-section">
                                <h3>Face Scan Registration</h3>
                                <video id="video-preview-register" autoplay playsinline></video>
                                <div id="registerScanStatus" class="success-msg"></div>
                                <button type="button" class="secondary-btn" onclick="startCamera('video-preview-register')">1. Start Camera</button>
                                <button type="button" class="secondary-btn" onclick="captureFace('video-preview-register', 'registerScanStatus')">2. Capture Face</button>
                            </div>
                        </div>
                        <!-- Lecturer Register Fields -->
                        <div class="form-fields hidden" data-for-type="lecturer" >
                            <p style="text-align: center; color: var(--text-dark);">Enter your details to create a lecturer account.</p>
                            <input type="text" name="name" placeholder="Full Name" required>
                            <input type="text" name="lecturer_id" placeholder="Lecturer ID" required>
                            <input type="email" name="email" placeholder="Email Address" required>
                            <input type="tel" name="phone" placeholder="Phone Number" required>
                            <input type="password" name="password" placeholder="Password" required>
                        </div>
                         <div id="registerError" class="error-msg"></div>
                         <div id="registerSuccess" class="success-msg"></div>
                        <button type="submit">Register</button>
                    </form>
                </div>
            </div>
        </div>
        
    

        <!-- PAGE 2: STUDENT DASHBOARD -->
        <div id="studentDashboard" class="page">
             <div class="card">
                <h1 id="studentWelcome"></h1>
                <h2>Mark Attendance</h2>
                <form id="attendanceForm">
                    <input type="text" name="code" placeholder="Enter Attendance Code" required>
                    <div id="studentError" class="error-msg"></div>
                    <div id="studentSuccess" class="success-msg"></div>
                    <button type="submit">Submit Code</button>
                </form>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- PAGE 3: ENHANCED LECTURER DASHBOARD -->
        <div id="lecturerDashboard" class="page">
            <div class="card">
                <h1 id="lecturerWelcome"></h1>
                
                <h2>My Courses</h2>
                <div id="coursesList" style="margin-bottom: 20px;"></div>
                <button onclick="document.getElementById('createCourseCard').classList.toggle('hidden')">Create New Course</button>
                <button onclick="showAttendanceReportUI()">View Attendance Reports</button>
            </div>

            <div id="createCourseCard" class="card hidden">
                <h2>Create a New Course</h2>
                <form id="courseForm">
                    <input type="text" name="courseCode" placeholder="Course Code (e.g., CSC101)" required>
                    <input type="text" name="courseTitle" placeholder="Course Title" required>
                    <button type="submit">Create</button>
                </form>
            </div>
            
            <div class="card">
                <h2>Generate Attendance Code</h2>
                <form id="generateCodeForm">
                    <select name="courseId" id="courseSelectForCode" required>
                        <option value="">-- Select a Course --</option>
                    </select>
                    <div id="lecturerError" class="error-msg"></div>
                    <button type="submit">Generate</button>
                </form>
                <div id="generatedCodeDisplay" class="success-msg" style="font-size: 1.5em; font-weight: bold;"></div>
            </div>
            
            <!-- ENHANCED ATTENDANCE REPORT SECTION -->
            <div id="attendanceReportCard" class="card hidden">
                <h2>ðŸ“Š Attendance Reports & Analytics</h2>
                
                <select id="courseSelectForReport">
                    <option value="">-- Select a Course to View Report --</option>
                </select>
                
                <!-- Sessions Overview Container -->
                <div id="sessionsContainer">
                    <!-- Sessions will be loaded here dynamically -->
                </div>
                
                <!-- Session Details Container -->
                <div id="attendanceDetailsContainer">
                    <!-- Detailed attendance records will be loaded here -->
                </div>
                
                <!-- Quick Actions -->
                <div style="margin-top: 20px; text-align: center;">
                    <button class="secondary-btn" onclick="printCourseReport()">ðŸ“„ Print Full Course Report</button>
                </div>
            </div>
            
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <!-- PAGE 4: ADMIN DASHBOARD -->
        <div id="adminDashboard" class="page">
             <div class="card">
                 <h1>Admin Dashboard</h1>
                 <p>This is a placeholder for admin functionalities, such as viewing all users, courses, and system-wide statistics.</p>
                 <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

    </div>
<!-- Replace the face-api.js script section in your index.html with this complete solution -->

<!-- Method 1: Use CDN instead of local file (Recommended for quick fix) -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<!-- Method 2: Alternative CDN -->
<!-- <script src="https://justadudewhohacks.github.io/face-api.js/dist/face-api.min.js"></script> -->

<!-- Face API Initialization Script -->
<script>
let faceApiLoaded = false;

    // Check if face-api.js is properly loaded
    function isFaceApiReady() {
        return typeof faceapi !== 'undefined' && 
               faceapi.nets && 
               faceapi.nets.ssdMobilenetv1 && 
               faceapi.nets.faceLandmark68Net && 
               faceapi.nets.faceRecognitionNet;
    }

    // Update status messages
    function updateFaceStatus(message, isError = false) {
        const statusElements = document.querySelectorAll('[id$="ScanStatus"]');
        statusElements.forEach(el => {
            el.textContent = message;
            el.className = isError ? 'error-msg' : 'success-msg';
        });
        console.log(isError ? 'ERROR:' : 'INFO:', message);
    }

    // Load face-api.js models with comprehensive error handling
    async function loadFaceApiModels() {
        try {
            updateFaceStatus('Checking face-api.js library...');
            
            // Wait for face-api.js library to be available
            let attempts = 0;
            while (!isFaceApiReady() && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!isFaceApiReady()) {
                throw new Error('face-api.js library not loaded properly');
            }
            
            updateFaceStatus('Loading face recognition models...');
            
            // Try multiple CDN sources
            const modelSources = [
                'https://justadudewhohacks.github.io/face-api.js/models',
                'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js-models@master',
                'https://raw.githubusercontent.com/justadudewhohacks/face-api.js-models/master'
            ];
            
            let modelsLoaded = false;
            let lastError = null;
            
            for (const modelUrl of modelSources) {
                try {
                    console.log(`Trying to load models from: ${modelUrl}`);
                    
                    await Promise.all([
                        faceapi.nets.ssdMobilenetv1.loadFromUri(modelUrl),
                        faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
                        faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl)
                    ]);
                    
                    console.log(`Models loaded successfully from: ${modelUrl}`);
                    modelsLoaded = true;
                    break;
                    
                } catch (error) {
                    console.log(`Failed to load from ${modelUrl}:`, error.message);
                    lastError = error;
                }
            }
            
            if (!modelsLoaded) {
                throw new Error(`Failed to load models from all sources. Last error: ${lastError?.message}`);
            }
            
            // Add helper function
            if (!faceapi.bufferToImage) {
                faceapi.bufferToImage = function(buffer) {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = reject;
                        img.src = URL.createObjectURL(buffer);
                    });
                };
            }
            
            // Test the setup
            updateFaceStatus('Testing face detection...');
            await testFaceApi();
            
            faceApiLoaded = true;
            updateFaceStatus('Face recognition ready! You can now capture your face.');
            
        } catch (error) {
            console.error('Face-API loading failed:', error);
            faceApiLoaded = false;
            updateFaceStatus(`Face recognition failed: ${error.message}`, true);
            
            // Provide fallback instructions
            setTimeout(() => {
                updateFaceStatus('Try refreshing the page or check your internet connection', true);
            }, 2000);
        }
    }

    // Test face-api functionality
    async function testFaceApi() {
        try {
            // Create a test canvas
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, 100, 100);
            
            // Try to run detection (should not error even with no faces)
            await faceapi.detectAllFaces(canvas);
            console.log('Face-API test passed');
            
        } catch (error) {
            throw new Error(`Face-API test failed: ${error.message}`);
        }
    }

    // Initialize when everything is ready
    async function initializeFaceApi() {
        try {
            // Wait for DOM
            if (document.readyState === 'loading') {
                await new Promise(resolve => {
                    document.addEventListener('DOMContentLoaded', resolve);
                });
            }
            
            // Wait for face-api.js script
            updateFaceStatus('Loading face-api.js library...');
            
            let scriptLoadAttempts = 0;
            while (typeof faceapi === 'undefined' && scriptLoadAttempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 100));
                scriptLoadAttempts++;
            }
            
            if (typeof faceapi === 'undefined') {
                throw new Error('face-api.js script failed to load');
            }
            
            // Load models
            await loadFaceApiModels();
            
        } catch (error) {
            console.error('Face-API initialization failed:', error);
            updateFaceStatus('Face recognition unavailable. Please refresh the page.', true);
        }
    }

    // Manual retry function
    window.retryFaceApi = function() {
        console.log('Retrying face-api.js initialization...');
        faceApiLoaded = false;
        initializeFaceApi();
    };

    // Debug function
    window.debugFaceApi = function() {
        console.log('=== Face-API Debug Info ===');
        console.log('faceapi available:', typeof faceapi !== 'undefined');
        console.log('Models loaded:', faceApiLoaded);
        console.log('Document ready:', document.readyState);
        
        if (typeof faceapi !== 'undefined') {
            console.log('Available networks:', Object.keys(faceapi.nets || {}));
        }
    };

    // Start initialization
    initializeFaceApi();
</script>


<script src="js/auth.js"></script>
</body>
</html>
