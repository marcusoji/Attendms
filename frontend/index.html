<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Attendance System</title>
     <link rel="stylesheet" href="css/style.css">
</head>
<body>

   <div class="container">
        <!-- PAGE 1: AUTHENTICATION -->
        <div id="authPage" class="page active">
            <h1>School Attendance System</h1>
            <canvas id="captureCanvas" class="hidden"></canvas>

            <div class="card">
                <div class="toggle-container">
                    <button id="authToggleLogin" class="toggle-btn active" onclick="switchAuthMode('login')">Login</button>
                    <button id="authToggleRegister" class="toggle-btn" onclick="switchAuthMode('register')">Register</button>
                </div>

                <!-- LOGIN FORM --> 
                <div id="loginForm">
                    <div class="tab-container">
                        <button class="tab-btn active" data-user-type="student" onclick="switchUserType(this)">Student</button>
                        <button class="tab-btn" data-user-type="lecturer" onclick="switchUserType(this)">Lecturer</button>
                        <button class="tab-btn" data-user-type="admin" onclick="switchUserType(this)">Admin</button>
                    </div>
                    <form id="login-form-element">
                        <!-- Student Login Fields -->
                        <div class="form-fields" data-for-type="student">
                            <input type="text" name="matNo" placeholder="Matriculation Number" required>
                            <div class="face-scan-section">
                                <h3>Face Scan Login</h3>
                                <video id="video-preview-login" autoplay playsinline></video>
                                <div id="loginScanStatus" class="success-msg"></div>
                                <button type="button" class="secondary-btn" onclick="startCamera('video-preview-login')">1. Start Camera</button>
                                <button type="button" class="secondary-btn" onclick="captureFace('video-preview-login', 'loginScanStatus')">2. Capture Face</button>
                            </div>
                        </div>
                        <!-- Lecturer/Admin Login Fields -->
                        <div class="form-fields hidden" data-for-type="lecturer admin">
                            <input type="email" name="email" placeholder="Email Address" required>
                            <input type="password" name="password" placeholder="Password" required>
                        </div>
                        <div id="loginError" class="error-msg"></div>
                        <button type="submit">Login</button>
                    </form>
                </div>

                <!-- REGISTER FORM -->
                <div id="registerForm" class="hidden">
                     <div class="tab-container">
                        <button class="tab-btn active" data-user-type="student" onclick="switchUserType(this)">Student</button>
                        <button class="tab-btn" data-user-type="lecturer" onclick="switchUserType(this)">Lecturer</button>
                    </div>
                    <form id="register-form-element">
                         <!-- Student Register Fields -->
                         <div class="form-fields" data-for-type="student">
                            <input type="text" name="name" placeholder="Full Name" required>
                            <input type="text" name="matNo" placeholder="Matriculation Number" required>
                            <input type="email" name="email" placeholder="Email Address" required>
                            <input type="tel" name="phone" placeholder="Phone Number" required>
                            <div class="face-scan-section">
                                <h3>Face Scan Registration</h3>
                                <video id="video-preview-register" autoplay playsinline></video>
                                <div id="registerScanStatus" class="success-msg"></div>
                                <button type="button" class="secondary-btn" onclick="startCamera('video-preview-register')">1. Start Camera</button>
                                <button type="button" class="secondary-btn" onclick="captureFace('video-preview-register', 'registerScanStatus')">2. Capture Face</button>
                            </div>
                        </div>
                        <!-- Lecturer Register Fields -->
                        <div class="form-fields hidden" data-for-type="lecturer" >
                            <p style="text-align: center; color: var(--text-dark);">Enter your details to create a lecturer account.</p>
                            <input type="text" name="name" placeholder="Full Name" required>
                            <input type="text" name="lecturer_id" placeholder="Lecturer ID" required>
                            <input type="email" name="email" placeholder="Email Address" required>
                            <input type="tel" name="phone" placeholder="Phone Number" required>
                            <input type="password" name="password" placeholder="Password" required>
                        </div>
                         <div id="registerError" class="error-msg"></div>
                         <div id="registerSuccess" class="success-msg"></div>
                        <button type="submit">Register</button>
                    </form>
                </div>
            </div>
        </div>
        
    

        <!-- PAGE 2: STUDENT DASHBOARD -->
        <div id="studentDashboard" class="page">
             <div class="card">
                <h1 id="studentWelcome"></h1>
                <h2>Mark Attendance</h2>
                <form id="attendanceForm">
                    <input type="text" name="code" placeholder="Enter Attendance Code" required>
                    <div id="studentError" class="error-msg"></div>
                    <div id="studentSuccess" class="success-msg"></div>
                    <button type="submit">Submit Code</button>
                </form>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- PAGE 3: ENHANCED LECTURER DASHBOARD -->
        <div id="lecturerDashboard" class="page">
            <div class="card">
                <h1 id="lecturerWelcome"></h1>
                
                <h2>My Courses</h2>
                <div id="coursesList" style="margin-bottom: 20px;"></div>
                <button onclick="document.getElementById('createCourseCard').classList.toggle('hidden')">Create New Course</button>
                <button onclick="showAttendanceReportUI()">View Attendance Reports</button>
            </div>

            <div id="createCourseCard" class="card hidden">
                <h2>Create a New Course</h2>
                <form id="courseForm">
                    <input type="text" name="courseCode" placeholder="Course Code (e.g., CSC101)" required>
                    <input type="text" name="courseTitle" placeholder="Course Title" required>
                    <button type="submit">Create</button>
                </form>
            </div>
            
            <div class="card">
                <h2>Generate Attendance Code</h2>
                <form id="generateCodeForm">
                    <select name="courseId" id="courseSelectForCode" required>
                        <option value="">-- Select a Course --</option>
                    </select>
                    <div id="lecturerError" class="error-msg"></div>
                    <button type="submit">Generate</button>
                </form>
                <div id="generatedCodeDisplay" class="success-msg" style="font-size: 1.5em; font-weight: bold;"></div>
            </div>
            
            <!-- ENHANCED ATTENDANCE REPORT SECTION -->
            <div id="attendanceReportCard" class="card hidden">
                <h2>📊 Attendance Reports & Analytics</h2>
                
                <select id="courseSelectForReport">
                    <option value="">-- Select a Course to View Report --</option>
                </select>
                
                <!-- Sessions Overview Container -->
                <div id="sessionsContainer">
                    <!-- Sessions will be loaded here dynamically -->
                </div>
                
                <!-- Session Details Container -->
                <div id="attendanceDetailsContainer">
                    <!-- Detailed attendance records will be loaded here -->
                </div>
                
                <!-- Quick Actions -->
                <div style="margin-top: 20px; text-align: center;">
                    <button class="secondary-btn" onclick="printCourseReport()">📄 Print Full Course Report</button>
                </div>
            </div>
            
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <!-- PAGE 4: ADMIN DASHBOARD -->
        <div id="adminDashboard" class="page">
             <div class="card">
                 <h1>Admin Dashboard</h1>
                 <p>This is a placeholder for admin functionalities, such as viewing all users, courses, and system-wide statistics.</p>
                 <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

    </div>
<!-- Replace the face-api.js script section in your index.html with this complete solution -->

<!-- Method 1: Use CDN instead of local file (Recommended for quick fix) -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<!-- Method 2: Alternative CDN -->
<!-- <script src="https://justadudewhohacks.github.io/face-api.js/dist/face-api.min.js"></script> -->

<!-- Face API Initialization Script -->
<script>
// Enhanced Face API Loading with multiple fallback strategies
let faceApiLoaded = false;
let loadingAttempts = 0;
const maxLoadingAttempts = 3;

// Check if face-api.js is available
function checkFaceApiAvailability() {
    return (typeof faceapi !== 'undefined' && 
            faceapi.nets && 
            faceapi.nets.ssdMobilenetv1 && 
            faceapi.nets.faceLandmark68Net && 
            faceapi.nets.faceRecognitionNet);
}

// Wait for face-api.js to load with enhanced checking
function waitForFaceApi() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 100; // Wait up to 10 seconds
        
        function checkFaceApi() {
            attempts++;
            
            if (checkFaceApiAvailability()) {
                console.log('✅ face-api.js library loaded successfully');
                resolve();
            } else if (attempts < maxAttempts) {
                setTimeout(checkFaceApi, 100);
            } else {
                reject(new Error('face-api.js failed to load after 10 seconds'));
            }
        }
        
        checkFaceApi();
    });
}

// Load face-api.js dynamically if it's not available
async function loadFaceApiDynamically() {
    return new Promise((resolve, reject) => {
        if (checkFaceApiAvailability()) {
            resolve();
            return;
        }

        console.log('Loading face-api.js dynamically...');
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js';
        script.async = true;
        
        script.onload = () => {
            console.log('face-api.js script loaded via dynamic loading');
            // Wait a bit for the library to initialize
            setTimeout(() => {
                if (checkFaceApiAvailability()) {
                    resolve();
                } else {
                    reject(new Error('face-api.js loaded but not properly initialized'));
                }
            }, 1000);
        };
        
        script.onerror = () => {
            reject(new Error('Failed to load face-api.js script dynamically'));
        };
        
        document.head.appendChild(script);
    });
}

// Load models with multiple fallback URLs
async function loadModelsWithFallback() {
    const modelUrls = [
        '/models', // Local server
        'https://justadudewhohacks.github.io/face-api.js/models', // Official CDN
        'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js-models@master' // Alternative CDN
    ];
    
    for (let i = 0; i < modelUrls.length; i++) {
        try {
            console.log(`Attempting to load models from: ${modelUrls[i]}`);
            
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(modelUrls[i]),
                faceapi.nets.faceLandmark68Net.loadFromUri(modelUrls[i]),
                faceapi.nets.faceRecognitionNet.loadFromUri(modelUrls[i])
            ]);
            
            console.log(`✅ Models loaded successfully from: ${modelUrls[i]}`);
            return true;
            
        } catch (error) {
            console.log(`❌ Failed to load from ${modelUrls[i]}:`, error.message);
            if (i === modelUrls.length - 1) {
                throw new Error('Failed to load models from all sources');
            }
        }
    }
}

// Main face API loading function with comprehensive error handling
async function loadFaceApiModels() {
    loadingAttempts++;
    
    if (loadingAttempts > maxLoadingAttempts) {
        console.error('❌ Maximum loading attempts reached');
        showFaceApiError('Maximum loading attempts reached. Please refresh the page.');
        return;
    }
    
    try {
        console.log(`Loading face-api.js (attempt ${loadingAttempts}/${maxLoadingAttempts})...`);
        
        // Show loading message
        updateFaceApiStatus('Loading face recognition... Please wait.', 'success-msg');
        
        // Step 1: Ensure face-api.js library is loaded
        try {
            await waitForFaceApi();
        } catch (waitError) {
            console.log('Standard loading failed, trying dynamic loading...');
            await loadFaceApiDynamically();
            // Wait again after dynamic loading
            await waitForFaceApi();
        }
        
        // Step 2: Load the models
        console.log('Loading face recognition models...');
        await loadModelsWithFallback();
        
        // Step 3: Initialize helper functions
        initializeHelperFunctions();
        
        // Step 4: Mark as successfully loaded
        faceApiLoaded = true;
        console.log('✅ Face-api.js fully initialized and ready!');
        
        // Update UI
        updateFaceApiStatus('Face recognition ready! ✅', 'success-msg');
        
        // Test the setup
        await testFaceApiSetup();
        
    } catch (error) {
        console.error('❌ Failed to load face-api.js:', error);
        faceApiLoaded = false;
        
        const errorMessage = error.message || 'Unknown error occurred';
        showFaceApiError(`Face recognition failed to load: ${errorMessage}`);
        
        // Retry after a delay
        if (loadingAttempts < maxLoadingAttempts) {
            console.log(`Retrying in 3 seconds... (${loadingAttempts}/${maxLoadingAttempts})`);
            setTimeout(() => {
                loadFaceApiModels();
            }, 3000);
        }
    }
}

// Test face-api.js setup
async function testFaceApiSetup() {
    try {
        console.log('Testing face-api.js setup...');
        
        // Create a small test image
        const canvas = document.createElement('canvas');
        canvas.width = 100;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');
        
        // Draw a simple test pattern
        ctx.fillStyle = '#f0f0f0';
        ctx.fillRect(0, 0, 100, 100);
        ctx.fillStyle = '#333';
        ctx.fillRect(40, 40, 20, 20);
        
        // Try to detect faces (should find none, but shouldn't error)
        const detections = await faceapi.detectAllFaces(canvas);
        console.log(`✅ Face-api.js test completed. Detected ${detections.length} faces in test image.`);
        
    } catch (testError) {
        console.warn('⚠️ Face-api.js test failed:', testError.message);
        // Don't mark as failed since models might still work for real images
    }
}

// Helper function to update face API status messages
function updateFaceApiStatus(message, className) {
    document.querySelectorAll('[id$="ScanStatus"]').forEach(el => {
        el.textContent = message;
        el.className = className;
    });
}

// Show face API error
function showFaceApiError(message) {
    updateFaceApiStatus(message, 'error-msg');
    
    // Also show in console for debugging
    console.error('Face API Error:', message);
}

// Initialize helper functions
function initializeHelperFunctions() {
    if (typeof faceapi !== 'undefined') {
        // Helper to convert blob to image
        faceapi.bufferToImage = function(buffer) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    console.log('Image loaded for face recognition');
                    resolve(img);
                };
                img.onerror = (error) => {
                    console.error('Failed to load image:', error);
                    reject(error);
                };
                img.src = URL.createObjectURL(buffer);
            });
        };
        
        console.log('Helper functions initialized');
    }
}

// Manual retry function for troubleshooting
window.retryFaceApiLoad = function() {
    console.log('🔄 Manually retrying face-api models loading...');
    loadingAttempts = 0;
    faceApiLoaded = false;
    loadFaceApiModels();
};

// Check for face-api.js availability and show helpful debug info
window.debugFaceApi = function() {
    console.log('=== Face-API.js Debug Info ===');
    console.log('faceapi available:', typeof faceapi !== 'undefined');
    console.log('faceapi.nets available:', typeof faceapi !== 'undefined' && !!faceapi.nets);
    console.log('Models loaded:', faceApiLoaded);
    console.log('Loading attempts:', loadingAttempts);
    
    if (typeof faceapi !== 'undefined' && faceapi.nets) {
        console.log('Available nets:');
        Object.keys(faceapi.nets).forEach(net => {
            console.log(`  ${net}:`, !!faceapi.nets[net]);
        });
    }
    
    // Test network connectivity
    fetch('/models/ssd_mobilenetv1_model-weights_manifest.json')
        .then(response => console.log('Local models accessible:', response.ok))
        .catch(error => console.log('Local models not accessible:', error.message));
    
    console.log('==============================');
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Starting face-api.js initialization...');
    
    // Show initial loading message
    updateFaceApiStatus('Initializing face recognition...', 'success-msg');
    
    // Start loading after a brief delay to ensure DOM is ready
    setTimeout(() => {
        loadFaceApiModels();
    }, 100);
});

// Handle page visibility changes (retry when page becomes visible)
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && !faceApiLoaded && loadingAttempts < maxLoadingAttempts) {
        console.log('Page became visible, retrying face-api.js loading...');
        setTimeout(loadFaceApiModels, 1000);
    }
});
</script>


<script src="js/auth.js"></script>
</body>
</html>
